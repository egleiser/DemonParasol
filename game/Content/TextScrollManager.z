/////////////////////////////////////////
////                                 ////
////  Name: TextScrollManager.z      ////
////    Written by: Jason Clark      ////
////     Last Updated: 9-17-14       ////
////                                 ////
/////////////////////////////////////////
class TextScrollManager : ZilchComponent
{
    //TextBlock taken from TextBlockElieInfo
    var TextBlockToPrint : TextBlock = null;
    
    //The complete string that will be printed
    var GoalString : String = null;
    //The string as it exists each moment while it is printed
    var CurrentString : String = null;
    //The index of the character in the string that is being printed
    var CurrentIndex : Integer = 0;
    
    var TextDelay : Real = 0.0;
    var IsPunctuation : Boolean = false;
    
    //Variables taken from the TextBlockElieInfo
    var SpeakerPicture : SpriteSource = null;
    var SpeakerName : String = "";
    var SpeakerCog : Cog = null;
    
    //A higher delay to use after certain punctuation marks
    [Property]
    var PunctuationDelay : Real = 0.1;
    
    //The standard delay for printing characters
    [Property]
    var LetterDelay : Real = 0.05;
    
    //The Action Set that controls the delays
    var TextSeq : ActionSet = null;
    
    function Initialize(init : CogInitializer)
    {
        Zero.Connect(this.Owner, "textScrollEvent", this.OntextScrollEvent);
    }

    function OntextScrollEvent(event : TextScrollEvent)
    {
        if(this.TextSeq != null)
        {
            this.TextSeq.Cancel();
        }
        
        this.CurrentIndex = 0;
        this.CurrentString = null;
        this.GoalString = event.TextToWrite.Text;
        
        this.TextSeq = Action.Sequence(this.Owner.Actions);
        
        Actions.Delay(this.TextSeq, this.TextDelay);
        Actions.Call(this.TextSeq, this.TextScroll);
        //this.ParticleScroll(this.CurrentIndex);
    }
    
    function TextScroll()
    {
        if(this.GoalString == this.CurrentString)
        {
            this.TextSeq.Cancel();
            return;
        }
        
        this.CurrentString = this.GoalString.SubString(0, this.CurrentIndex + 1);
        
        var currentCharacterInt:Integer = this.GoalString.Get(this.CurrentIndex);
        var currentCharacter:String = null;
        
        currentCharacter = String.FromChar(currentCharacterInt);
        
        this.TextDelay = this.LetterDelay;
        
        if(this.IsPunctuation)
        {
            this.TextDelay = this.PunctuationDelay;
            this.IsPunctuation = false;
        }
        if(currentCharacter == "." || currentCharacter == "?" || currentCharacter == "!")
        {
            this.IsPunctuation = true;
        }
        
        this.CurrentIndex += 1;
        
        //this is where the extra screen wrapping code would go
        
        this.Owner.SpriteText.Text = this.CurrentString;
        
        this.TextSeq = Action.Sequence(this.Owner.Actions);
        
        Actions.Delay(this.TextSeq, this.TextDelay);
        Actions.Call(this.TextSeq, this.TextScroll);
        //this.ParticleScroll(this.CurrentIndex);
    }
    
    //function ParticleScroll(currentCharacterIndex:Integer)
    //{
    //    var particle:Cog = this.Space.FindObjectByName("TextBoxParticle");
        
    //    var currentCharacterPosition:Real3 = this.Owner.SpriteText.GetCharacterPosition(currentCharacterIndex);
    //    Console.WriteLine("Pos: `currentCharacterPosition`");
        //currentCharacterPosition = this.Owner.Transform.TransformPoint(currentCharacterPosition);
        
        //particle.SpriteParticleSystem.Visible = true;
        //particle.Transform.Translation = currentCharacterPosition;// = Math.Lerp(particle.Transform.Translation, currentCharacterPosition, 1.0);
    //}
}
    
    //    Console.WriteLine("TextScrollEvent");
    //    var seq = Action.Sequence(this.Owner.Actions);
    //    
    //    for(var i:Integer = 0; i < event.TextToWrite.Text.Count; ++i)
    //    {
    //        Action.Property(seq, @this.Owner.SpriteText.Text, event.TextToWrite.Text.SubString(0, i), 0.1, Ease.Linear);
    //    }
    //}
    //